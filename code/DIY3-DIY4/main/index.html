<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transducer Dashboard</title>
    <!-- This is for the favicon, it should be a hardcoded version of the one in the repo -->
    <link href="data:image/x-icon;base64,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" rel="icon" type="image/x-icon" />
    <style>
        :root {
            --default-font: Arial, Helvetica, sans-serif;
            --max-grid-column-width: 500px;
        }
        body {
            margin: 0;
            background-color: whitesmoke;
            font-family: var(--default-font);
        }
        header {
            background-color: dodgerblue;
            color: white;
            text-align: center;
            padding: 0.5rem;
        }
        header > h1 {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        header > a {
            text-decoration: none;
        }
        
        header > a:hover {
            text-decoration: underline;
        }
        
        header > a:visited {
            color:inherit;
        }
        @media(min-width: 1100px) {
            header {
                display: grid;
                grid-template-columns: 1fr 2fr 1fr;
                align-items: center;
            }
            header > h1 {
                grid-column: 2 / 3;
            }

            header > a {
                grid-column: 3 / 4;
                justify-self: right;
                margin-right: 1rem;
            }
        }

        .grid-container {
            margin-top: 1rem;

            display: grid;
            grid-template-columns: repeat(1, 95vw);
            gap: 2rem;
            /* grid-auto-flow: row; */
            
            justify-content: center;
            /* align-content: center; */

            /* justify-items: center; */
        }

        @media(min-width: 1100px) {
            .grid-container {
                grid-template-columns: repeat(2, var(--max-grid-column-width));
            }
        }
        .grid-item {
            padding: 1rem;
            background-color: white;
            border-radius: 1rem;
        }
        .grid-item > h2 {
            color: dodgerblue;
            margin-top: 0;
        }

        .dynamic-data {
            font-family: 'Courier New', Courier, monospace;
            line-height: 1;
        }

        #device-status-connected {
            color: green;
            font-weight: bold;
        }

        #device-status-disconnected {
            color: red;
            font-weight: bold;
        }

        .tooltip {
            position: relative;
        }

        .tooltip .tooltiptext {
            font-family: var(--default-font);
            visibility: hidden;
            width: 250px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 0%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* .far {
            margin-right: 5px;
            color: #00F;
            padding: 7px;
        } */
    </style>
</head>
<body>
    <header>
        <h1>Pressure Transducer Dashboard</h1>
        <a href="https://github.com/benchittle/pressure-transducer">GitHub Repository &#x29c9;</a>
    </header>

    <div class="grid-container">
        <div class="grid-item device">
            <h2>Device</h2>
            <p>
                Device name: <span class="dynamic-data" id="device-name">unknown</span> 
            </p>
            <p>
                Connection status: 
                <span class="dynamic-data tooltip" id="device-status-disconnected">DISCONNECTED &#9432;
                    <span class="tooltiptext">
                        Make sure you are connected to the transducer's network and try refreshing the page.
                    </span>
                </span>
                <!-- <span class="tooltip" data-tooltip="Check that you are connected to the transducer's network and try reloading the page">?</span> -->
                
                <span class="dynamic-data" id="device-status-connected" hidden>CONNECTED</span>
            </p>
            <p id="device-status-last-connected" hidden>
                Time last connected: <time class="dynamic-data" id="device-status-disconnected-time"></time>
            </p>
        </div>
        <div class="grid-item data">
            <h2>Data</h2>
            <p>
                MicroSD card capacity (bytes): <span class="dynamic-data" id="data-storage-capacity">unknown</span>
            </p>
            <p>
                MicroSD card capacity used (bytes): <span class="dynamic-data" id="data-storage-used">unknown</span>
            </p>
        </div>
        <div class="grid-item clock">
            <h2>Clock</h2>
            <p>
                Transducer clock time: <time class="dynamic-data" id="clock-onboard">unknown</time>
            </p>

            <input type="radio" id="clock-from-system" name="set-clock" checked onclick="disableClockInput();">
            <label for="clock-from-system">Set transducer clock from browser clock</label>
            <br>
            <input type="radio" id="clock-from-custom" name="set-clock" onclick="enableClockInput();">
            <label for="clock-from-custom">Set transducer clock from custom time</label>
            <br>
            <input type="datetime-local" step="1" id="clock-input" disabled>
            <button id="clock-set-button" onclick="setOnboardClock();" disabled>Set transducer clock</button>
        </div>
        <div class="grid-item sensor">
            <h2>Sensor</h2>
            <p>
                Pressure (mbar): <span class="dynamic-data" id="sensor-pressure">unknown</span>
            </p>
            <p>
                Temperature (&deg;C): <span class="dynamic-data" id="sensor-temperature">unknown</span>
            </p>
            <button id="sensor-update-button" onclick="updateSensorSection();" disabled>Read sensor</button>
        </div>
    </div>

    <script>
        class NetworkError extends Error {
            constructor(message) {
                super(message);
                this.name = "NetworkError";
            }
        }   

        class ApiError extends Error {
            constructor(message) {
                super(message);
                this.name = "ApiError";
            }
        } 

        class TransducerService {
            async getAll() {
                const RESOURCE = "/api/all";
                let response;
                try {
                    response = await fetch(RESOURCE,  {
                        cache: "no-store"
                    });
                } catch(error) {
                    throw new NetworkError(`Failed to retrieve ${RESOURCE} (${error})`);
                }
                if (!response.ok) {
                    throw new ApiError(`Failed to retrieve ${RESOURCE} (${response.status} ${response.statusText})`); 
                }
                return response.json();
            }

            async getClock() {
                const RESOURCE = "/api/clock";
                let response;
                try {
                    response = await fetch(RESOURCE,  {
                        cache: "no-store"
                    });
                } catch(error) {
                    throw new NetworkError(`Failed to retrieve ${RESOURCE} (${error})`);
                }
                if (!response.ok) {
                    throw new ApiError(`Failed to retrieve ${RESOURCE} (${response.status} ${response.statusText})`); 
                }
                return response.json();
            }

            async setClock(timeEpochSec) {
                const RESOURCE = "/api/clock";
                let response;
                try {
                    response = await fetch(RESOURCE, {
                        method: "POST",
                        headers: {
                            "Content-Type": "text/plain", 
                        },
                        body: timeEpochSec.toString(),
                    })
                } catch(error) {
                    throw new NetworkError(`Failed to set ${RESOURCE} (${error})`);
                }
                if (!response.ok) {
                    throw new ApiError(`Failed to set ${RESOURCE} (${response.status} ${response.statusText})`);
                }
            }

            async getSensor() {
                const RESOURCE = "/api/sensor";
                let response;
                try {
                    response = await fetch(RESOURCE);
                } catch(error) {
                    throw new NetworkError(`Failed to retrieve ${RESOURCE}: ${error}`);
                }
                if (!response.ok) {
                    throw new ApiError(`Failed to retrieve ${RESOURCE}: ${response.status} ${response.statusText}`);  
                }
                return response.json();
            }
        }

        const MAX_FAILED_DASHBOARD_UPDATES = 6;
        let UPDATE_DASHBOARD_TIMEOUT = 1000;
        
        const transducerService = new TransducerService();

        let failedDashboardUpdates = 0;
        let connected = false;

        document.addEventListener("DOMContentLoaded", init);
        window.addEventListener("online", () => {
            console.log("Network connection acquired");
            connect();
        });
        window.addEventListener("offline", () => {
            console.log("Network connection lost");
            if (connected) {
                disconnect();
            }
        });

        function init() {
            if (window.navigator.onLine) {
                connect();
            } else {
                console.log("Unable to initialize dashboard: you are offline")
            }
        }

        function connect() {
            transducerService.getAll()
                .then(data => {
                    populateDashboard(data);
                    failedDashboardUpdates = 0;
                    setTimeout(updateDashboard, UPDATE_DASHBOARD_TIMEOUT);
                    enableDashboard();

                    connected = true;
                    console.log("Connected to transducer");
                })
                .catch(error => {
                    connected = false;
                    if (error instanceof NetworkError) {
                        console.log("Failed to connect to transducer")
                    } else {
                        console.error(error)
                        console.log("Failed to connect to transducer")
                    }
                });
        }

        function disconnect() {
            connected = false;
            disableDashboard();
            console.log("Disconnected from transducer");
        }

        async function updateDashboard() {
            if (!connected) {
                console.log("Cancelling dashboard updates");
                return;
            }
            const startTime = Date.now();
            try {
                const data = await transducerService.getClock();
                populateClockSection(data["clock_time"]);
                failedDashboardUpdates = 0;
                setTimeout(updateDashboard, Math.max(0, UPDATE_DASHBOARD_TIMEOUT - (Date.now() - startTime)));
            } catch(error) {
                console.error(error);
                if (failedDashboardUpdates >= MAX_FAILED_DASHBOARD_UPDATES) {
                    console.log(`Failed to update the dashboard ${failedDashboardUpdates} times in a row. Disconnecting`)
                    disconnect();
                } else {
                    console.log("Failed to update the dashboard. Trying again...")
                    failedDashboardUpdates += 1;
                    setTimeout(updateDashboard, Math.max(0, UPDATE_DASHBOARD_TIMEOUT - (Date.now() - startTime)));
                }
            }
        }

        function enableDashboard() {
            document.getElementById("device-status-disconnected").hidden = true;
            document.getElementById("device-status-last-connected").hidden = true;
            document.getElementById("device-status-connected").hidden = false;
            
            document.getElementById("clock-set-button").disabled = false;

            document.getElementById("sensor-update-button").disabled = false;
        }

        function disableDashboard() {
            const now = new Date();
            //now.setMinutes(now.getMinutes() - now.getTimezoneOffset());

            document.getElementById("device-status-connected").hidden = true;
            document.getElementById("device-status-disconnected").hidden = false;
            elementDeviceStatusDisconnectedTime = document.getElementById("device-status-disconnected-time");
            elementDeviceStatusDisconnectedTime.textContent = `${now.getHours()}:${("0" + now.getMinutes()).slice(-2)}`;
            elementDeviceStatusDisconnectedTime.setAttribute("datetime", now.toISOString());
            document.getElementById("device-status-last-connected").hidden = false;
            
            document.getElementById("clock-set-button").disabled = true;

            document.getElementById("sensor-update-button").disabled = true;
        }
        
        function populateDashboard(data) {
            populateDeviceSection(data["device_name"]);
            populateDataSection(data["storage_capacity"], data["storage_used"]);
            populateClockSection(data["clock_time"]);
            populateSensorSection(data["sensor_pressure"], data["sensor_temperature"]);
        }

        function populateDeviceSection(deviceName) {
            document.getElementById("device-name").textContent = deviceName;
        }

        function populateDataSection(storageCapacity, storageUsed) {
            document.getElementById("data-storage-capacity").textContent = storageCapacity;
            document.getElementById("data-storage-used").textContent = storageUsed + " (" + (storageUsed / storageCapacity * 100).toString().slice(0, 4) + "%)";
        }

        function populateClockSection(onboardTimeEpochSec) {
            if (!document.getElementById("clock-from-custom").checked) {
                updateClockInput()
            }
            const onboardDatetime = new Date(onboardTimeEpochSec * 1000);
            // Create time string in form YYYY-MM-DD hh:mm:ss
            const onboardTimeString = onboardDatetime.getUTCFullYear() + "-" 
                + ("0"+ (onboardDatetime.getUTCMonth() + 1)).slice(-2) + "-" 
                + ("0" + onboardDatetime.getUTCDate()).slice(-2) + " " 
                + ("0" + onboardDatetime.getUTCHours()).slice(-2) + ":" 
                + ("0" + onboardDatetime.getUTCMinutes()).slice(-2) + ":"
                + ("0" + onboardDatetime.getUTCSeconds()).slice(-2);

            const onboardClockDisplay = document.getElementById("clock-onboard");
            onboardClockDisplay.setAttribute("datetime", onboardDatetime.toISOString());
            onboardClockDisplay.textContent = onboardTimeString;
        }

        function populateSensorSection(pressure, temperature) {
            document.getElementById("sensor-pressure").textContent = pressure;
            document.getElementById("sensor-temperature").textContent = temperature;
        }

        // Set the value of the input section to the browser's current time
        function updateClockInput() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById("clock-input").value = now.toISOString().slice(0,19);
        }

        function setOnboardClock() {
            const timeStringIso = document.getElementById("clock-input").value + "Z";
            // Not necessarily the actual GMT time, but it doesn't matter since 
            // we're just working in local time.
            let timeEpochSec = new Date(timeStringIso).getTime() / 1000;
            if (document.getElementById("clock-from-system").checked) {
                // Add 1 to account for delay
                timeEpochSec += 1;
            }
            
            transducerService.setClock(timeEpochSec)
                .then(() => {
                    console.log(`Set onboard clock time to ${timeEpochSec} (${timeStringIso})`);
                })
                .catch(error => {
                    console.error(error);
                    console.log("Failed to set onboard clock");
                });
        }

        function enableClockInput() {
            document.getElementById("clock-input").disabled = false;
        }

        function disableClockInput() {
            document.getElementById("clock-input").disabled = true;
            if (connected) {
                updateClockInput();
            }
        }

        function updateSensorSection() {
            transducerService.getSensor()
                .then(data => populateSensorSection(data["sensor_pressure"], data["sensor_temperature"]))
                .catch(error => console.error(error));
        }
    </script>
</body>
</html>